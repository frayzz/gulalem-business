# Модуль CRM + склад для цветочного магазина

Цель: принять заказ за 2–3 действия на мобайле, контролировать остатки по партиям и видеть маржу. Базовый выбор для реализации — **PWA** (один фронт для мобайла/ПК) и **учёт всего ассортимента по штукам/метрам** (цветы, упаковка, расходники, сборки).

## Ключевые сущности
- **Заказы**: продажа/доставка/самовывоз/предзаказ, статусы `Новый → В работе → Готов → Выдан|Доставлен → Завершён|Отменён`.
- **Склад**: партии цветов/материалов, FIFO списание, инвентаризация, корректировки.
- **Клиенты**: история, предпочтения, дни рождения, быстрый поиск по телефону.
- **Букеты/сборки**: рецепты для автосписания компонент.
- **Касса**: оплаты (нал/карта/перевод/смешанная), скидки, долги, возвраты, смены.
- **Сотрудники**: роли, смены, журнал действий.

## UX
### Мобайл (продавец/флорист)
Нижняя навигация: `Заказы`, `Касса`, `Склад`, `Клиенты`, `Ещё`.
- **Заказы**: список (поиск/фильтр по статусу), кнопка «Создать». В форме — клиент (поиск/скан телефона), тип доставки, товары (крупные карточки, быстрые пресеты «11 роз»), скидка, оплата. Таймер статуса.
- **Касса**: принять оплату, закрыть смену, быстрое разделение по методам, кнопка «Печать чека»/«Отправить». 
- **Склад**: остатки с цветными индикаторами свежести, действия «Приход», «Списать», «Инвентаризация».
- **Клиенты**: быстрый поиск, история заказов, заметки.
- **Ещё**: отчёты дня, смена, настройки печати, справка.

### ПК (владелец/управляющий)
Левое меню: Заказы, Склад (`Остатки/Движения`), Товары, Сборки, Клиенты, Отчёты, Настройки.
- Таблицы с фильтрами по дате/статусу/типу оплаты/доставки.
- Двойной экран для операций склада: таблица партий + карточка операции.
- Конструктор рецептов букета (список компонентов, подсказка себестоимости).
- Отчёты: выручка, себестоимость, прибыль, топ списаний, просрочка партий.

## MVP-потоки
1. **Создание заказа ≤ 60 секунд**
   - Поиск/создание клиента → выбор типа доставки → добавление товаров/букетов → скидка → оплата (нал/карта/перевод/смешанная) → чек.
2. **Склад**
   - Операции: приход (партиями), списание, инвентаризация, корректировка.
   - Автосписание при завершении заказа: позиция-товар списывается по FIFO из партий; позиция-букет списывает рецепт компонент.
3. **Касса/смена**
   - Открытие/закрытие смены, фиксация старт/конец кассы, отчёт по оплатам и возвратам.
4. **Отчёты**
   - Дневной дашборд: выручка, себестоимость, прибыль/маржа, топ списаний/просрочка.

## Модель данных (черновик)
- `users`, `roles`, `role_user` — доступ.
- `customers(id, name, phone, notes, birthday)`.
- `products(id, type: flower|material|bouquet, name, unit, sku, active)`.
- `product_batches(id, product_id, supplier_id, buy_price, qty_in, qty_left, arrived_at, expires_at?)`.
- `inventory_movements(id, product_id, batch_id?, type: in|out|adjust, qty, reason, order_id?, user_id, created_at)`.
- `bouquet_recipes(id, bouquet_product_id)` + `bouquet_recipe_items(recipe_id, product_id, qty)`.
- `orders(id, customer_id, status, delivery_type, delivery_address, delivery_time, total, discount, paid_total, payment_status)`.
- `order_items(order_id, product_id, qty, price, discount)`.
- `payments(order_id, method, amount)`.
- `cash_shifts(id, user_id, opened_at, closed_at, cash_start, cash_end)`.

## Правила склада
- Приход создаёт партию с датой и закупочной ценой; свежесть можно считать от `arrived_at` или `expires_at`.
- Списание по FIFO: берём старшую партию с остатком, уменьшаем `qty_left`, пишем движение `out` с `batch_id`.
- Автосписание заказа: 
  - если товар — обычный, списать `qty` по FIFO;
  - если товар — букет, развернуть рецепт и списать компоненты;
  - если партия не найдена → предупредить и позволить отрицательный остаток (опционально, по настройке).
- Инвентаризация: движения `adjust` на разницу по партиям.

## Роли и права (минимум)
- **Владелец**: все.
- **Админ/управляющий**: отчёты, цены, склад, сотрудники.
- **Продавец**: заказы, касса, клиенты.
- **Флорист**: статусы заказов, сборки, ограниченные списания.

## API-контур (REST)
- `POST /auth/login`, `POST /auth/logout`.
- `GET/POST/PUT /products`, `POST /products/{id}/deactivate`.
- `GET/POST /product-batches`, `POST /inventory/adjust`, `POST /inventory/write-off`, `POST /inventory/intake`.
- `GET/POST /bouquets` + `POST /bouquets/{id}/recipes`.
- `GET/POST /customers`.
- `GET/POST /orders`, `POST /orders/{id}/status`, `POST /orders/{id}/pay`, `POST /orders/{id}/receipt`.
- `GET /reports/summary?range=day|week|month`, `GET /reports/waste-top`, `GET /reports/margin`.
- `GET/POST /cash-shifts`, `POST /cash-shifts/{id}/close`.

## Стек
- Backend: Laravel 11/12 + MySQL.
- Frontend: React + TypeScript + Tailwind, PWA, real-time через Echo/Pusher при необходимости.
- Печать: web print view + чековый принтер на ПК.

## Этапы ввода в работу
1. Авторизация, роли, карточка магазина.
2. Номенклатура: товары, единицы, цены.
3. Склад: партии, приход/списание/инвентаризация.
4. Сборки букетов и расчёт себестоимости.
5. Заказы + оплата + чек.
6. Автосписание FIFO при завершении заказа.
7. Отчёты + закрытие смены.
8. Интеграции: мессенджеры, доставка, импорт/экспорт.

## Допущения для старта
- Деплой как PWA, чтобы на мобайле всё работало «в 2 тапа» без отдельного приложения.
- Учет остатков ведём для всех типов товаров (цветы, упаковка, расходники, букеты как рецепты).
- Возвраты и долги оформляются через кассу с отдельными движениями склада/оплаты.
